<!DOCTYPE html>
<html lang="en">
<head>
  <% include partials/head %>
  <link rel="stylesheet" href="/css/campus-map.css">
  <link rel="stylesheet" href="/css/statueList.css">
</head>
<body>
  <%- include('partials/header') %>
  <main>
    <div class="jumbotron text-center">
      <h1>Campus Map</h1>
    </div>
    <div class="container">
      <div class="row">
        <div id="map"></div>
      </div>
    </div>
  </main>
  <% include partials/footer %>
</body>
<script>

  $(document).ready(function() {
    $('#map').on('submit', '.statue-flag-form', function(ev) {
      ev.preventDefault();
      const $this = $(ev.target);
      const statueId = $this.find('input[name=statueId]').val();
      const isFlagged = $this.find('input[name=isFlagged]').val();
      $.ajax({
        url: '/statue-flag',
        method: 'POST',
        data: {
          isFlagged: isFlagged,
          statueId: statueId,
          isJson: 1
        },
        success: function(data) {
          const statueId = data.statueId;
          const $statueCard = $('#statue-' + statueId);
          $statueCard.find('.text-flag')[0].innerText = data.isFlagged;
          $statueCard.find('.flag-btn')[0].innerText = data.isFlagged ? 'Unflag' : 'Flag';
          $statueCard.find('input[name=isFlagged]').val(data.isFlagged);
        },
        error: function(xhr) {

        }
      });
    });

    $('#map').on('submit', '.statue-private-form', function(ev) {
      ev.preventDefault();
      const $this = $(ev.target);
      const statueId = $this.find('input[name=statueId]').val();
      const isPrivate = $this.find('input[name=isPrivate]').val();
      $.ajax({
        url: '/statue-private',
        method: 'POST',
        data: {
          isPrivate: isPrivate,
          statueId: statueId,
          isJson: 1
        },
        success: function(data) {
          const statueId = data.statueId;
          const $statueCard = $('#statue-' + statueId);
          $statueCard.find('.text-private')[0].innerText = data.isPrivate ? 'Private' : 'Public';
          $statueCard.find('.private-btn')[0].innerText = data.isPrivate ? 'Set public' : 'Set private';
          $statueCard.find('input[name=isPrivate]').val(data.isPrivate);
        },
        error: function(xhr) {

        }
      });
    });

    $('#map').on('submit', '.statue-remove-form', function(ev) {
      ev.preventDefault();
      const $this = $(ev.target);
      const statueId = $this.find('input[name=statueId]').val();
      $.ajax({
        url: '/statue',
        method: 'POST',
        data: {
          statueId: statueId,
          isJson: 1
        },
        success: function(data) {
          location.reload();
        },
        error: function(xhr) {

        }
      });
    });

  });

  function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 15,
      center: {
        lat: 33.777993,
        lng: -84.398108
      }
    });
    let marker;
    <% Object.keys(maps).forEach((m, i) => { %>
      marker = new google.maps.Marker({
        position: {
          lat: <%= maps[m].latitude %>,
          lng: <%= maps[m].longitude %>
        },
        map: map,
        id: "<%= m %>"
      });

      marker.addListener('mouseover', (function(marker, i) {
        marker = this;
        $.ajax({
          url: '/statue/' + marker.id,
          success: function(data) {
            const statue = data.statue;
            const previewPicURL = statue.statuePreviewPicURL;
            const imageURL = previewPicURL.substr(0, 95) + '%2f' + previewPicURL.substr(96);
            const str =
              '<div class="card" ' + ' id="statue-' + marker.id + '"' + '>' +
                '<img class="card-img-top" src="' + imageURL + '" alt="' + statue.name + '">' +
                '<div class="card-body">' +
                  '<h5 class="card-title">' + statue.name + '</h5>' +
                  '<p class="card-text">' + statue.description + '</p>' +
                  '<div class="statue-info-container">' +
                    '<p class="statue-info">Like: <span>' + statue.like + '</span></p>' +
                    '<p class="statue-info">Dislike: <span>' + statue.dislike + '</span></p>' +
                    '<div class="option-container">' +
                      '<span class="statue-info">Flagged: <span class="text-flag">' + statue.isFlagged + '</span></span>' +
                      '<form class="statue-flag-form" action="/statue-flag" method="post">' +
                        '<input type="hidden" name="statueId" value="' + marker.id + '">' +
                        '<input type="hidden" name="isFlagged" value="' + statue.isFlagged + '">' +
                        '<button class="flag-btn btn alert-danger" type="submit" class="btn alert-danger remove-btn" data-statue-name="' + statue.name + '">' +
                        (statue.isFlagged ? 'Unflag' : 'Flag') +
                        '</button>' +
                      '</form>' +
                    '</div>' +
                    '<div class="option-container">' +
                      '<span class="statue-info"><span class="text-private">' + (statue.isPrivate ? 'Private' : 'Public') + '</span></span>' +
                      '<form class="statue-private-form" action="/statue-private" method="post">' +
                        '<input type="hidden" name="statueId" value="' + marker.id + '">' +
                        '<input type="hidden" name="isPrivate" value="' + statue.isPrivate + '">' +
                        '<button class="private-btn btn alert-danger" type="submit" class="btn alert-danger remove-btn" data-statue-name="' + statue.name + '">' +
                        (statue.isPrivate ? 'Set public' : 'Set private') +
                        '</button>' +
                      '</form>' +
                    '</div>' +
                  '</div>' +
                  '<div class="button-container">' +
                    '<form class="statue-remove-form" action="/statue" method="post">' +
                      '<input type="hidden" name="statueId" value="' + marker.id + '">' +
                      '<button class="remove-btn btn alert-danger" type="submit" class="btn alert-danger remove-btn" data-statue-name="' + statue.name + '">Remove</button>' +
                    '</form>' +
                  '</div>' +
                '</div>' +
              '</div>';
            const infowindow = new google.maps.InfoWindow({
              content: str
            });
            infowindow.open(map, marker);
          },
          error: function(xhr) {

          }
        });
      }));
    <% }) %>
  }
</script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-126jQxDJMWuci63ka1o_NtHoWogIudk&callback=initMap">
  </script>
</html>
